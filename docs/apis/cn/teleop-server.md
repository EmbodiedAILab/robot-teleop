## 服务网关接口设计

本文档描述了一个基于 WebRTC 的移动机器人遥操作服务网关的设计。以微服务形式对外伺服，服务网关能够连接客户端和远端机器人。
客户端可以通过服务网关进行业务鉴权、机器人列表、会话管理、组件创建等。
本文档将详细讨论场景分析、系统架构设计、接口设计和服务部署方案，以及服务的南北向 API 设计。

### 0. 简介

为了实现WebRTC服务网关和客户端、远端机器人之间的通信，我们需要设计一些接口来传递信令、媒体和控制信息。

#### 客户端和WebRTC服务网关之间的接口
客户端和WebRTC服务网关之间主要通过WebSocket协议进行双向通信，传递信令信息。信令信息主要包括以下几类：

- **房间管理**：客户端可以通过发送`join`、`leave`等消息来加入或离开一个房间，房间是指一组进行音视频通话的客户端和机器人的集合。WebRTC服务网关会返回相应的响应消息，如joined、left等，以及房间内其他成员的信息。
- **媒体协商**：客户端可以通过发送`offer`、`answer`、`candidate`等消息来进行媒体协商，即交换SDP（Session Description Protocol）和ICE（Interactive Connectivity Establishment）信息，建立音视频连接。WebRTC服务网关会转发这些消息给对应的目标客户端或机器人。
- **控制指令**：客户端可以通过发送一些控制指令来对远端机器人进行操作，如移动、旋转、抓取等。这些指令由具体的业务场景定义，WebRTC服务网关会转发这些指令给对应的机器人。
- **状态反馈**：WebRTC服务网关可以向客户端发送一些状态反馈信息来报告其当前的状态，如位置、速度、电量等。这些状态反馈信息由具体的业务场景定义，客户端可以将这些信息展示给用户或用于监控分析。
- **事件信息**：WebRTC服务网关可以向客户端发送一些事件信息来报告其当前的状态，如机器人加入房间、离开房间、发送媒体流等。这些事件信息由具体的业务场景定义，客户端可以将这些信息展示给用户或用于监控分析。
- **信令信息**：WebRTC服务网关可以向客户端发送一些信令信息来控制其行为，如加入房间、离开房间、发送媒体流等。这些信令信息由具体的业务场景定义，客户端可以将这些信息展示给用户或用于监控分析。
- **业务消息**：WebRTC服务网关可以向客户端发送一些业务消息来报告其当前的状态，如机器人加入房间、离开房间、发送媒体流等。这些业务消息由具体的业务场景定义，客户端可以将这些信息展示给用户或用于监控分析。

#### WebRTC服务网关和远端机器人之间的接口

WebRTC服务网关和远端机器人之间主要通过UDP协议进行单向或双向通信，传递媒体和控制信息。媒体和控制信息主要包括以下几类：

- **媒体流**：WebRTC服务网关可以向远端机器人发送或接收音视频流，音视频流是经过RTP（Real-time Transport Protocol）封装的数据包，包含了音视频数据和元数据。音视频流可以用于实现实时监视或回放功能。
- **控制指令**：WebRTC服务网关可以向远端机器人发送一些控制指令来对其进行操作，如移动、旋转、抓取等。这些指令由具体的业务场景定义，远端机器人会根据收到的指令执行相应的动作。
- **状态反馈**：远端机器人可以向WebRTC服务网关发送一些状态反馈信息来报告其当前的状态，如位置、速度、电量等。这些状态反馈信息由具体的业务场景定义，WebRTC服务网关可以将这些信息展示给客户端或用于监控分析。
- **信令信息**：WebRTC服务网关可以向远端机器人发送一些信令信息来控制其行为，如加入房间、离开房间、发送媒体流等。这些信令信息由具体的业务场景定义，远端机器人会根据收到的信令信息执行相应的动作。
- **配置信息**：远端机器人可以向WebRTC服务网关发送一些配置信息，如已预置的技能、机器人型号等。

### 1. 场景分析

- [Teleop-Robot](./teleop-robot.md) 作为遥操作的远端机器人，需要通过 WebSocket 协议与服务网关进行状态更新、房间管理、信令和数据交互等服务。
- [Teleop-Client](./teleop-client.md) 作为遥操作的客户端，需要通过 WebSocket 协议与服务网关进行机器人列表获取、房间管理、信令和数据交互等服务。

### 2. 系统架构设计

服务网关作为遥操作服务的核心，需要提供 Websocket 协议的接口供客户端调用，同时需要与远端机器人进行通信。

#### 2.1 关键组件

- **Websocket Server**: 服务网关提供 Websocket 协议的接口供客户端调用，同时需要与远端机器人进行通信。
- **Redis**: 服务网关需要使用 Redis 作为缓存数据库，用于存储客户端的会话信息、机器人列表、房间信息等。
- **Signaling Server**: 服务网关需要使用 Signaling Server 作为信令服务，用于客户端和远端机器人之间的信令交互。
- **STUN/TURN Server**: 服务网关需要使用 STUN/TURN Server 作为 ICE 服务，用于客户端和远端机器人之间的 ICE 交互。

### 3. 接口设计

服务网关所提供的接口分为两类：服务管理接口（Restful）和业务接口（Websocket）。通过配合使用这两类接口，客户端可以完整的使用服务网关的所有功能，包括业务鉴权、机器人列表、会话管理、组件创建等。

#### 3.1 服务管理

这里的服务管理接口主要是指对接云平台相关服务的管理面接口。

##### 3.1.1 API 概览

- Server URL: http://{teleop-server-endpoint}:{teleop-server-port}/v1/service

| 对象      | 类型    | 说明                       |
|---------|-------|--------------------------|
| service | 服务管理  | 服务管理接口，用于服务的创建、查询、删除等    |
 | robot   | 机器人管理 | 机器人管理接口，用于机器人的信息查询、服务部署等 |
| room    | 房间管理  | 房间管理接口，用于房间的创建、查询、删除等    |

##### 3.1.2 API 详细说明
见 [Teleop-Server-API](./teleop-server-api.md)

#### 3.2 业务接口

这里的业务接口包括 Websocket 信令和 Websocket 数据两部分服务。
其中 Websocket 信令用于客户端和远端机器人之间的信令交互，Websocket 数据用于客户端和远端机器人之间的数据交互。

##### 3.2.1 API 概览

- Server URL: ws://{teleop-server-endpoint}:{teleop-server-port}/{service_id}

##### 3.2.2 API 详细说明

见 [Teleop-Server-API](./teleop-server-api.md)

### 4. 服务部署方案

TBA